name: Test Packaged Server SDKs

on:
  workflow_dispatch:
  push:

jobs:

  test-packaged-server-sdks:


    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        sdk:
          - { sdkName: "eppo/php-sdk", 
              sdkDir: "php-sdk-relay",
              hostAddressFromDocker: "172.18.0.1"
            }

    runs-on: ubuntu-latest
    env:
        SDK_NAME: ${{matrix.sdk.sdkName}}
        SDK_DIR: ${{ matrix.sdk.sdkDir }}
        EPPO_API_HOST: ${{matrix.sdk.hostAddressFromDocker}}
        SDK_RELAY_HOST: ${{matrix.sdk.hostAddressFromDocker}}
        TEST_RUNNER_HOST: ${{matrix.sdk.hostAddressFromDocker}}

    steps:

    
    - name: Test information header   
      shell: bash
      run: echo "Running Test Cluster for ${{ matrix.sdk.sdkName }}"


    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

    - uses: actions/checkout@v3

    - name: Prepare test runner image
      run: |
        pushd package-testing/sdk-test-runner
        docker build . -t Eppo-exp/sdk-test-runner:latest
        echo "pull the latest instead"
        popd

    - name: Prepare testing API server image
      run: |
        pushd package-testing/testing-api
        docker build . -t Eppo-exp/test-api-server:latest
        echo "pull the latest instead"
        popd

    - name: Run tests
      run: |
        pushd package-testing/sdk-test-runner
        ./test-sdk.sh server ${{ matrix.sdk.sdkName }}
        ls -al ./logs
        popd

    - name: Upload Logs
      if: success() || failure() # always run even if the previous steps fail
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.date.outputs.date }}-${{ matrix.sdk.sdkName }}-sdk-test-logs
        path: logs/

    - name: Test Report
      if: success() || failure() # always run even if the previous steps fail
      run: |
        echo "Link to the rendered test report"
        pushd package-testing/sdk-test-runner      
        ls logs
        popd

    # - name: Publish Test Report
    #   uses: mikepenz/action-junit-report@v5
    #   if: success() || failure() # always run even if the previous steps fail
    #   with:
    #     report_paths: 'package-testing/sdk-test-runner/logs/TEST-*.xml'

    # - name: Test Report
    # if: success() || failure() # always run even if the previous steps fail
    # run: |
    #   echo "Link to the rendered test report"
    #   pushd package-testing/sdk-test-runner      
    #   ls logs
    #   cat logs/test_runner.log
    #   popd
