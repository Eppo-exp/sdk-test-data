name: Test Packaged Server SDKs

on:
  workflow_dispatch:

jobs:

  test-packaged-server-sdks:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        sdk:
          - { sdkName: "eppo/php-sdk", sdkDir: "php-sdk-relay" }

    runs-on: ubuntu-latest
    steps:
    - name: Test information header
      env:
        SDK_NAME: ${{matrix.sdk.sdkName}}
      shell: bash
      run: echo "Running Test Cluster for ${{ matrix.sdk.sdkName }}"


    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

    - uses: actions/checkout@v3

    - name: Prepare test runner image
      run: |
        pushd package-testing/sdk-test-runner
        docker build . -t Eppo-exp/sdk-test-runner:latest
        echo "pull the latest instead"
        popd

    - name: Prepare testing API server image
      run: |
        pushd package-testing/testing-api
        docker build . -t Eppo-exp/test-api-server:latest
        echo "pull the latest instead"
        popd

    - name: Run tests
      env:
        SDK_DIR: ${{ matrix.sdk.sdkDir }}
      run: |
        pushd package-testing/sdk-test-runner
        ./test-sdk.sh server ${{ matrix.sdk.sdkName }}
        ls -al ./logs
        popd

    - name: Test Report
      run: |
        echo "Link to the rendered test report"
        pushd package-testing/sdk-test-runner      
        ls logs
        popd

    # - name: Publish Test Report
    #   uses: mikepenz/action-junit-report@v5
    #   if: success() || failure() # always run even if the previous steps fail
    #   with:
    #     report_paths: 'package-testing/sdk-test-runner/logs/TEST-*.xml'

    # - name: Test Report
    # if: success() || failure() # always run even if the previous steps fail
    # run: |
    #   echo "Link to the rendered test report"
    #   pushd package-testing/sdk-test-runner      
    #   ls logs
    #   cat logs/test_runner.log
    #   popd
